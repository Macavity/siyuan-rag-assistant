<template>
  <div class="chat-interface">
    <!-- Settings Warning -->
    <div v-if="!isConfigured" class="settings-warning">
      <div class="warning-icon">‚ö†Ô∏è</div>
      <div class="warning-content">
        <div class="warning-title">Configuration Required</div>
        <div class="warning-message">Please configure Ollama URL and model in settings.</div>
      </div>
    </div>

    <!-- Chat History Area -->
    <div class="chat-history" ref="historyContainer">
      <div 
        v-for="(message, index) in messages" 
        :key="index" 
        :class="['message', message.role]"
      >
        <div class="message-content" v-html="formatMessage(message.content)"></div>
      </div>
      
      <!-- Loading indicator -->
      <div v-if="isLoading" class="message assistant">
        <div class="message-content">
          <div class="typing-indicator">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Input Area -->
    <div class="input-area">
      <!-- Document context indicator -->
      <div v-if="hasDocumentContext" class="context-indicator">
        <div class="context-icon">üìÑ</div>
        <div class="context-text">
          <span 
            v-if="documentContext.documentId || documentContext.blockId"
            class="block-ref" 
            :data-type="'block-ref'" 
            :data-id="documentContext.documentId || documentContext.blockId"
            :data-subtype="'d'"
            @click="openDocument"
          >
            {{ documentName ? documentName : 'Current Document' }}
          </span>
          <span v-else>{{ documentName ? documentName : 'Current Document' }}</span>
        </div>
      </div>
      
      <label class="input-label">Ask a question</label>
      <SyTextarea 
        v-model="currentInput"
        class="input-textarea"
        :disabled="!isConfigured || isLoading"
        @keydown.ctrl.enter="handleSendMessage"
      />
      <SyButton 
        class="send-button"
        @click="handleSendMessage"
        :disabled="!isConfigured || isLoading"
      >
        <span v-if="isLoading">Sending...</span>
        <span v-else>Send</span>
      </SyButton>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, onBeforeUnmount, nextTick } from 'vue'
import SyTextarea from './SiyuanTheme/SyTextarea.vue'
import SyButton from './SiyuanTheme/SyButton.vue'
import { usePlugin } from '@/main'
import RAGAssistantPlugin from '@/index'
import { useChatHistory } from '@/composables/useChatHistory'
import { useDocumentContext } from '@/composables/useDocumentContext'
import { useChatMessages } from '@/composables/useChatMessages'

const plugin = usePlugin() as unknown as RAGAssistantPlugin

// Initialize composables
const { messages, switchToDocument, addMessage, saveChatHistory } = useChatHistory(plugin)
const { hasDocumentContext, documentName, documentContext, buildContextualMessage, openDocument, initDocumentContext } = useDocumentContext()
const { isConfigured, isLoading, historyContainer, checkConfiguration, sendMessage, scrollToBottom } = useChatMessages(plugin)

const currentInput = ref('')

// Format message content - convert newlines to HTML breaks
const formatMessage = (content: string) => {
  if (!content) return ''
  return content.replace(/\n/g, '<br>')
}

// Handle document context changes
const unsubscribe = initDocumentContext(async (context) => {
  const newDocumentId = context.documentId || context.blockId
  
  // Switch to the new document's chat history
  await switchToDocument(newDocumentId)
  
  // Save chat history after messages change
  if (newDocumentId) {
    await saveChatHistory(newDocumentId)
  }
})

onBeforeUnmount(() => {
  if (unsubscribe) {
    unsubscribe()
  }
})

// Initialize on mount
onMounted(async () => {
  await checkConfiguration()
})

// Handle sending messages
const handleSendMessage = async (event?: MouseEvent | KeyboardEvent) => {
  if (event) {
    event.preventDefault()
  }
  
  if (!currentInput.value.trim() || !isConfigured.value) {
    return
  }

  const userMessage = currentInput.value.trim()
  currentInput.value = ''

  // Build contextual message
  const { contextualMessage, systemMessage } = await buildContextualMessage(userMessage)

  // Add user message to history
  addMessage({ role: 'user', content: userMessage })

  // Scroll to bottom
  await nextTick()
  scrollToBottom()

  // Scroll to show loading indicator
  await nextTick()
  scrollToBottom()

  try {
    // Send message via composable
    await sendMessage(userMessage, contextualMessage, systemMessage, messages)
    
    // Save chat history after receiving response
    const currentDocId = documentContext.value.documentId || documentContext.value.blockId
    if (currentDocId) {
      await saveChatHistory(currentDocId)
    }
  } catch (error) {
    // Error already handled in composable
  }
  
  // Scroll again after response
  await nextTick()
  scrollToBottom()
}
</script>

<style lang="scss" scoped>
.chat-interface {
  display: flex;
  flex-direction: column;
  height: 100%;
  width: 100%;
}

.chat-history {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  background-color: var(--b3-theme-surface);
  border-bottom: 1px solid var(--b3-border-color);
}

.message {
  display: flex;
  flex-direction: column;
  
  &.user {
    align-items: flex-end;
    
    .message-content {
      background-color: var(--b3-theme-primary);
      color: var(--b3-theme-on-primary);
      border-radius: var(--b3-border-radius);
      padding: 8px 12px;
      max-width: 80%;
      word-wrap: break-word;
    }
  }
  
  &.assistant {
    align-items: flex-start;
    
    .message-content {
      background-color: var(--b3-theme-surface-lighter);
      color: var(--b3-theme-on-surface);
      border-radius: var(--b3-border-radius);
      padding: 8px 12px;
      max-width: 80%;
      word-wrap: break-word;
    }
  }
}

.input-area {
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.context-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background-color: var(--b3-theme-background-light);
  border: 1px solid var(--b3-border-color);
  border-radius: var(--b3-border-radius);
  font-size: 12px;
  color: var(--b3-theme-on-surface-light);
}

.context-icon {
  flex-shrink: 0;
}

.context-text {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.block-ref {
  color: var(--b3-theme-primary);
  cursor: pointer;
}

.input-label {
  font-size: 14px;
  font-weight: 500;
  color: var(--b3-theme-on-surface);
}

.input-textarea {
  width: 100%;
  min-height: 80px;
  resize: vertical;
}

.send-button {
  align-self: flex-end;
  
  &:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
}

.settings-warning {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 12px;
  background-color: var(--b3-theme-background-light);
  border-bottom: 1px solid var(--b3-border-color);
  color: var(--b3-theme-on-surface);
}

.warning-icon {
  font-size: 20px;
  flex-shrink: 0;
}

.warning-content {
  flex: 1;
}

.warning-title {
  font-weight: 600;
  margin-bottom: 4px;
}

.warning-message {
  font-size: 14px;
  color: var(--b3-theme-on-surface-light);
}

.typing-indicator {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 8px 0;
  
  span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: var(--b3-theme-primary);
    animation: typing 1.4s infinite;
    
    &:nth-child(1) {
      animation-delay: 0s;
    }
    
    &:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    &:nth-child(3) {
      animation-delay: 0.4s;
    }
  }
}

@keyframes typing {
  0%, 60%, 100% {
    transform: translateY(0);
    opacity: 0.7;
  }
  30% {
    transform: translateY(-10px);
    opacity: 1;
  }
}
</style>

